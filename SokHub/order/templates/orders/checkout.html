<!-- order/checkout.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <!-- Navigation Button -->
    <div class="mb-4">
        <a href="{% url 'cart' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i> Back to Cart
        </a>
    </div>
    
    <div class="row">
        <!-- Checkout Form - Left Side -->
        <div class="col-lg-8">
            <h2 class="mb-4">Checkout</h2>
            
            <form method="post" id="checkoutForm">
                {% csrf_token %}
                
                <!-- Shipping Information -->
                <div class="mb-4">
                    <h4 class="mb-3">Shipping Information</h4>
                    <div class="card p-3">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Shipping Address</label>
                                {{ form.shipping_address }}
                                {% if form.shipping_address.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.shipping_address.errors %}
                                    <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">City/Town</label>
                                {{ form.shipping_city }}
                                {% if form.shipping_city.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.shipping_city.errors %}
                                    <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Phone Number</label>
                                {{ form.shipping_phone }}
                                {% if form.shipping_phone.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.shipping_phone.errors %}
                                    <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Delivery Instructions (Optional)</label>
                                {{ form.shipping_notes }}
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check">
                                    {{ form.save_shipping_address }}
                                    <label class="form-check-label" for="{{ form.save_shipping_address.id_for_label }}">
                                        {{ form.save_shipping_address.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method -->
                <div class="mb-4">
                    <h4 class="mb-3">Payment Method</h4>
                    <div class="card p-3">
                        <div class="mb-3">
                            {% for radio in form.payment_method %}
                            <div class="form-check mb-2">
                                {{ radio.tag }}
                                <label class="form-check-label" for="{{ radio.id_for_label }}">
                                    {{ radio.choice_label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Mobile Money Field - Shown only when Mobile Money is selected -->
                        <div id="momoField" class="mt-3" style="{% if form.payment_method.value != 'momo' %}display: none;{% endif %}">
                            <div class="border-start border-3 border-primary ps-3">
                                <label class="form-label fw-bold">{{ form.momo_number.label }}</label>
                                {{ form.momo_number }}
                                {% if form.momo_number.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.momo_number.errors %}
                                    <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="text-muted small mt-1">{{ form.momo_number.help_text }}</div>
                                
                                <div class="mt-2 p-2 bg-light rounded">
                                    <small><i class="fas fa-info-circle text-primary"></i> You'll receive a payment request on your phone</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Notes -->
                <div class="mb-4">
                    <h4 class="mb-3">Order Notes</h4>
                    <div class="card p-3">
                        {{ form.customer_notes }}
                        <div class="text-muted small mt-1">Special instructions for your order...</div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg w-100">Place Order</button>
            </form>
        </div>
        
        <!-- Order Summary - Right Side with Magenta Accents -->
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 20px;">
                <h4 class="mb-3 text-magenta">Order Summary</h4>
                <div class="card border-magenta shadow-sm">
                    <div class="card-header bg-magenta text-white">
                        <h5 class="mb-0"><i class="fas fa-shopping-bag me-2"></i>Your Order</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cart Items List -->
                        <div class="mb-3">
                            {% if request.session.cart %}
                                {% for product_id, item in request.session.cart.items %}
                                <div class="border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <span class="fw-medium">{{ item.name }}</span>
                                        <span class="fw-bold">RWF {{ item.price|floatformat:0 }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>Qty: {{ item.quantity }} Ã— RWF {{ item.price|floatformat:0 }}</span>
                                    </div>
                                    {% if item.vendor_name %}
                                    <div class="text-muted small">Vendor: {{ item.vendor_name }}</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-shopping-cart fa-2x mb-2"></i><br>
                                    Your cart is empty
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Order Totals with Magenta Highlights -->
                        <div class="border-top pt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal</span>
                                <span>RWF {{ subtotal|default:0|floatformat:0 }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 text-muted">
                                <span>Shipping</span>
                                <span class="text-success">RWF 0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 text-muted">
                                <span>Tax (18%)</span>
                                <span>RWF {{ tax|default:0|floatformat:0 }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3 fw-bold fs-5 border-top pt-2 text-magenta">
                                <span>TOTAL</span>
                                <span>RWF {{ total|default:0|floatformat:0 }}</span>
                            </div>
                        </div>
                        
                        <!-- Security & Payment Info with Magenta Accents -->
                        <div class="alert alert-light border-magenta mt-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-lock text-magenta me-2"></i>
                                <span class="fw-medium">Secure Payment</span>
                            </div>
                            <small class="text-muted">Your information is encrypted</small>
                        </div>
                        
                        <div class="alert alert-light border-magenta">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-bolt text-magenta me-2"></i>
                                <span class="fw-medium">Fastest: Mobile Money</span>
                            </div>
                            <small class="text-muted">Confirms instantly</small>
                        </div>
                        
                        <!-- Important Notice -->
                        <div class="alert alert-magenta-light border-magenta mt-3">
                            <small>
                                <i class="fas fa-exclamation-circle text-magenta me-1"></i>
                                By placing your order, you agree to our <a href="#" class="text-magenta">Terms & Conditions</a>
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Continue Shopping Button -->
                <div class="mt-3">
                    <a href="{% url 'product_list' %}" class="btn btn-outline-magenta w-100">
                        <i class="fas fa-plus me-2"></i> Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Magenta Color Scheme */
    .text-magenta {
        color: #9B26B6 !important;
    }
    
    .bg-magenta {
        background-color: #9B26B6 !important;
    }
    
    .border-magenta {
        border-color: #9B26B6 !important;
    }
    
    .btn-outline-magenta {
        color: #9B26B6;
        border-color: #9B26B6;
    }
    
    .btn-outline-magenta:hover {
        background-color: #9B26B6;
        color: white;
    }
    
    .alert-magenta-light {
        background-color: rgba(155, 38, 182, 0.1);
        border-color: rgba(155, 38, 182, 0.3);
    }
    
    .card.border-magenta {
        border-width: 2px;
    }
    
    /* Hover effects for cart items */
    .border-bottom:hover {
        background-color: rgba(155, 38, 182, 0.05);
        transition: background-color 0.3s ease;
    }
    
    /* Place Order Button with Magenta */
    .btn-primary {
        background-color: #9B26B6;
        border-color: #9B26B6;
    }
    
    .btn-primary:hover {
        background-color: #7a1f93;
        border-color: #7a1f93;
    }
    
    /* Sticky summary styling */
    .sticky-top {
        z-index: 1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle Mobile Money field based on payment method
    const momoField = document.getElementById('momoField');
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    
    function toggleMomoField() {
        const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
        if (selectedPayment && selectedPayment.value === 'momo') {
            momoField.style.display = 'block';
        } else {
            momoField.style.display = 'none';
        }
    }
    
    // Initial check
    toggleMomoField();
    
    // Add event listeners
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', toggleMomoField);
    });
    
    // Phone number validation
    const phoneInputs = document.querySelectorAll('input[id*="phone"], input[id*="momo"]');
    phoneInputs.forEach(input => {
        input.addEventListener('input', function() {
            // Format: allow only numbers and +
            this.value = this.value.replace(/[^0-9+]/g, '');
            
            // Validate format
            if (this.value.length > 0) {
                const isValid = this.value.match(/^(0[78]\d{8}|\+250[78]\d{7})$/);
                if (isValid) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            }
        });
    });
    
    // Add some interactive effects
    const totalElement = document.querySelector('.text-magenta.fw-bold');
    if (totalElement) {
        totalElement.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.transition = 'transform 0.2s ease';
        });
        
        totalElement.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    }
});
</script>
{% endblock %}